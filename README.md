Этот репозиторий содержит инструменты для анализа миграционных потоков и построения карт «якорных» городов. Данный README описывает только часть Pipeline: как собрать и проанализировать потоки.

Что вы получаете:
- загрузка подготовленной региональной модели из `pickle`;
- обновление численности населения городов;
- сбор и усреднение матриц передвижения по группам инфраструктуры;
- расчет показателей мобильности (самообеспеченность, покрытие опорными пунктами, потенциальные опорные пункты);
- экспорт результатов и сохранение статической карты потоков.


Быстрый старт:
- создать и активировать окружение Python 3.10;
- установить проект: `pip install -e .`;
- открыть `pipeline.ipynb` и выполнить ячейки разделов Pipeline.

**Исходные данные**
- `data/lo_region.pickle` — сериализованная региональная модель TownsNet;
- `data/provision/*.parquet` — матрицы связей вида `*_links.parquet` для типов сервисов (ребра «из -> в»);
- `data/1_polygons.parquet` — полигоны городов (для отрисовки);
- `data/anchor_settlement.csv` — признак «опорности» для городов (колонки: как минимум `is_anchor_settlement`).

Имена и местоположение файлов соответствуют тому, как они используются в `pipeline.ipynb` и методах модели.

**Основной сценарий (Pipeline)**

1) Загрузка модели
- `region = MigrationFlowModel.from_pickle("data/lo_region.pickle", seed=SEED)`
- Инициализируются города, сервисы и округа; готовим инфраструктурные группы.

2) Обновление населения (опционально)
- Подготовить `data/population.csv` (колонки: `region_city`, `population`).
- `population = pd.read_csv("data/population.csv")`
- `region.update_population(population)` — пересобирает слой городов с обновленной численностью.

3) Пересчет обеспеченности (опционально)
- Если появились новые данные сервисов или населения, следует пересчитать обеспеченность и сохранить обновленные данные:
- `region.calculate_provision(region.services.service_type.unique(), data_path="data/provision/updated", n_jobs=1)`

4) Загрузка матриц передвижения
- `region.load_migration_matrix(matrix_dir="data/provision", average=False, anchors=anchor_df)`
- Читает по каждой группе инфраструктуры parquet `*_links.parquet`, собирает разрежённые матрицы, строит объединенную матрицу и слой городов c флагом опорности.

5) Аналитика мобильности
- `mobilities = region.analyze_mobility(anchor_threshold=90)`
- Возвращает и сохраняет в объекте:
  - `self_sufficiency` — самообеспеченность по городам;
  - `anchor_coverage` — покрытие населенных пунктов опорными;
  - `anchor_stats` — сводка по опорным пунктам;
  - `potential_anchors` — кандидаты в опорные пункты при заданном пороге.

6) Карта потоков (статическое изображение)
- `region.save_static_map_png("data/out/flows.png")`
- Сохраняет PNG со схемой потоков и слоями якорей.

**Файлы и результаты**
- `data/population.csv` — скорректированная численность (если обновляли);
- `data/provision/*.parquet` — входные матрицы связей по сервисам;
- `data/provision/updated/*.parquet` — при пересчёте обеспеченности (опционально);
- `data/out/flows.png` — статическая карта потоков.